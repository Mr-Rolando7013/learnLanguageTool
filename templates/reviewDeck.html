<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Review Session</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            margin: 0;
            padding: 1rem;
            display: flex;
            justify-content: center;
        }

        .review-container {
            width: 100%;
            max-width: 600px;
            background: #020617;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .word-review {
            display: none;
        }

        .word-review.active {
            display: block;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        h2 {
            margin-top: 0;
        }

        .prompt {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        input, textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: none;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        button {
            background: #1e293b;
            color: #e5e7eb;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }

        button:hover {
            background: #334155;
        }

        .progress {
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .center {
            text-align: center;
        }
        .word-card {
        display: none;
        }

        .word-card.active {
        display: block;
        }
    </style>
</head>
<body>

<div class="review-container">

{% for chunk in chunks %}
<div class="chunk-review {% if loop.first %}active{% endif %}">
    <div class="progress">
        Card <span class="currentStep">1</span> / <span class="totalSteps">9</span>
    </div>

    <!-- TRANSLATION -->
    <div class="step active translation-step">
    {% for word in chunk %}
        <div class="word-card {% if loop.first %}active{% endif %}"
            data-word-id="{{ word.id }}">

        <h3>{{ word.word }}</h3>

        <div class="prompt">Translate:</div>
        <input
        data-step="translation"
        data-type="translation"
        data-question="Translate {{ word.word }}"
        />

        {% if word.sentence1 %}
            <div class="prompt"><strong>{{ word.sentence1 }}</strong></div>
            <input
            data-step="sentence1"
            data-type="sentence"
            data-question="{{ word.sentence1 }}"
            />
        {% endif %}

        {% if word.sentence2 %}
            <div class="prompt"><strong>{{ word.sentence2 }}</strong></div>
            <input
            data-step="sentence2"
            data-type="sentence"
            data-question="{{ word.sentence2 }}"
            />
        {% endif %}

        {% if word.sentence3 %}
            <div class="prompt"><strong>{{ word.sentence3 }}</strong></div>
            <input
            data-step="sentence3"
            data-type="sentence"
            data-question="{{ word.sentence3 }}"
            />
        {% endif %}
        </div>
    {% endfor %}

    <div class="center">
        <button onclick="prevWord(this)">Previous</button>
        <button onclick="nextWord(this)">Next</button>
    </div>
</div>


    <!-- MCQ Exercise 1 -->
    <div class="step mcq-step" data-mcq="1">
        <h2>Multiple Choice</h2>

        {% for word in chunk %}
            {% for mcq in word.mcq %}
            <div class="mcq" data-word-id="{{ word.id }}">
                <strong>{{ mcq.question }}</strong>

                {% for opt in [mcq.option1, mcq.option2, mcq.option3, mcq.option4] %}
                <label>
                    <input type="radio"
                        name="mcq1-{{ word.id }}"
                        data-step="mcq1"
                        data-type="mcq"
                        data-question="{{ mcq.question }}"
                        value="{{ opt }}">
                    {{ opt }}
                </label><br>
                {% endfor %}
            </div>
            {% endfor %}
        {% endfor %}

        <button onclick="prevStep(this)">Previous</button>
        <button onclick="nextStep(this)">Next</button>
        </div>

    <div class="step cloze-step" data-cloze="1">
    <h2>Cloze Exercises</h2>

    {% for word in chunk %}
        {% for cloze in word.cloze %}
        <div class="cloze" data-word-id="{{ word.id }}">
            <div class="prompt">
            {{ cloze.sentence }}
            </div>

            <input type="text"
                data-step="cloze-{{ cloze.id }}"
                data-type="cloze"
                data-question="{{ cloze.sentence }}"
                data-exercise-id="{{ cloze.id }}"
                placeholder="Missing wordâ€¦" />
        </div>
        {% endfor %}
    {% endfor %}

    <button onclick="prevStep(this)">Previous</button>
    <button onclick="nextStep(this)">Next</button>
    </div>

    <!-- STEP 4 -->
    <div class="step writing-step">
    <h2>Writing</h2>

    {% for word in chunk %}
        {% for writing in word.writing %}
        <div class="writing" data-word-id="{{ word.id }}">
            <div class="prompt">
            {{ writing.prompt }}
            </div>

            <textarea rows="3"
                    data-step="writing"
                    data-type="writing"
                    data-question="{{ writing.prompt }}"
                    data-exercise-id="{{ writing.id }}"
                    placeholder="Write your sentence hereâ€¦"></textarea>
        </div>
        {% endfor %}
    {% endfor %}

    <button onclick="prevStep(this)">Previous</button>
    <button onclick="finishChunk(this)">Finish</button>
    </div>

    

</div>
{% endfor %}
    <!-- FINISH -->
    <div class="step center">
        <h2>Review Complete ðŸŽ‰</h2>
        <p>Your answers have been recorded.</p>
        <p><strong>Score:</strong> <span class="score">â€“</span>%</p>
        <button onclick="submitResults(this)">Next Word</button>
    </div>

</div>

<script>

function nextWord(btn) {
  const step = btn.closest(".step");
  const cards = [...step.querySelectorAll(".word-card")];
  const active = step.querySelector(".word-card.active");

  const idx = cards.indexOf(active);
  if (idx === -1) return;

  active.classList.remove("active");

  if (cards[idx + 1]) {
    cards[idx + 1].classList.add("active");
  } else {
    // Last word â†’ move to next step (MCQ)
    step.classList.remove("active");
    step.nextElementSibling.classList.add("active");
  }
}

function nextStep(btn) {
  const step = btn.closest(".step");
  const chunk = btn.closest(".chunk-review");
  const steps = [...chunk.querySelectorAll(".step")];

  const idx = steps.indexOf(step);
  if (idx === -1 || !steps[idx + 1]) return;

  step.classList.remove("active");
  steps[idx + 1].classList.add("active");
}

function prevWord(btn) {
  const step = btn.closest(".step");
  const cards = [...step.querySelectorAll(".word-card")];
  const active = step.querySelector(".word-card.active");

  const idx = cards.indexOf(active);
  if (idx <= 0) return;

  active.classList.remove("active");
  cards[idx - 1].classList.add("active");
}

function finishChunk(btn) {
  const chunk = btn.closest(".chunk-review");
  const responses = [];

  chunk.querySelectorAll("[data-word-id]").forEach(block => {
    const wordId = block.dataset.wordId;

    block.querySelectorAll("input, textarea").forEach(input => {
      // radio: only collect checked
      if (input.type === "radio" && !input.checked) return;

      responses.push({
        word_id: wordId,
        step: input.dataset.step,
        type: input.dataset.type || null,
        exercise_id: input.dataset.exerciseId || null,
        question: input.dataset.question || null,
        answer: input.value
      });
    });
  });

  fetch("/review/submit", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ responses })
  });

  // Move to next chunk
  chunk.classList.remove("active");
  const next = chunk.nextElementSibling;

  if (next) {
    next.classList.add("active");
    next.querySelector(".step")?.classList.add("active");
  } else {
    alert("Session complete ðŸŽ‰");
  }
}



</script>

</body>
</html>